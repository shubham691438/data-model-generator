{
  "integrations": [
    {
      "type": "ReadApiIntegration",
      "integrationId": "tetrapak-get-application-stages",
      "responseConfig": {
        "responseType": "ARRAY_OF_ENTITIES",
        "jsonataExpression": "$.data.stages"
      },
      "dataModelRules": [
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "$count($$) > 0"
        },
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "$exists($.id) and $.id != null"
        }
      ],
      "dataModelTarget": {
        "dataModelJsonataExpression": "$map($$, function($stage) { { \"JOVEO_APPLICATION_STAGE_ID\": $uuid(), \"JOVEO_APPLICATION_STAGE_APPLICATION_ID\": $stage.application_id, \"JOVEO_APPLICATION_STAGE_CUSTOMER_ID\": \"{{customer_id}}\", \"ATS_APPLICATION_STAGE_JOB_ID\": $stage.job_id, \"ATS_APPLICATION_STAGE_CANDIDATE_ID\": $stage.candidate_id, \"ATS_APPLICATION_STAGE_APPLICATION_ID\": $stage.application_id, \"ATS_APPLICATION_STAGE_ID\": $stage.id, \"ATS_APPLICATION_STAGE_NAME\": $stage.name, \"ATS_APPLICATION_STAGE_CREATED_DATE\": $fromMillis($toMillis($replace($stage.created_at, /\\+\\d{2}:\\d{2}$/, \"\") & \"Z\")), \"ATS_APPLICATION_STAGE_LAST_UPDATED_DATE\": $fromMillis($toMillis($replace($stage.updated_at, /\\+\\d{2}:\\d{2}$/, \"\") & \"Z\")), \"ATS_APPLICATION_STAGE_INSERTED_AT\": $now(), \"ATS_APPLICATION_STAGE_UPDATED_AT\": $now(), \"ATS_APPLICATION_STAGE_CUSTOM_FIELDS\": { \"status\": $stage.status, \"notes\": $stage.notes, \"assigned_to\": $stage.assigned_to, \"due_date\": $stage.due_date }, \"ATS_APPLICATION_STAGE_AUDIT\": { \"created_by\": $stage.created_by, \"updated_by\": $stage.updated_by } } })",
        "targetFields": [
          "JOVEO_APPLICATION_STAGE_ID", "JOVEO_APPLICATION_STAGE_APPLICATION_ID", "JOVEO_APPLICATION_STAGE_CUSTOMER_ID", "ATS_APPLICATION_STAGE_JOB_ID", "ATS_APPLICATION_STAGE_CANDIDATE_ID", "ATS_APPLICATION_STAGE_APPLICATION_ID", "ATS_APPLICATION_STAGE_ID", "ATS_APPLICATION_STAGE_NAME", "ATS_APPLICATION_STAGE_CREATED_DATE", "ATS_APPLICATION_STAGE_LAST_UPDATED_DATE", "ATS_APPLICATION_STAGE_INSERTED_AT", "ATS_APPLICATION_STAGE_UPDATED_AT", "ATS_APPLICATION_STAGE_CUSTOM_FIELDS", "ATS_APPLICATION_STAGE_AUDIT"
        ],
        "targetOperation": "UPSERT"
      },
      "method": "GET",
      "authTypes": ["API_KEY"],
      "apiPath": "/api/v1/applications/{applicationId}/stages",
      "headers": {
        "X-API-KEY": "{{api_key}}",
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      "queryParams": {
        "page": "${page}",
        "size": "100"
      },
      "paginationConfig": {
        "type": "PageConfig",
        "pageSize": 100,
        "pageNumberKey": "page",
        "hasMoreDataJsonataExpression": "$exists($.data.next_page)"
      },
      "dateRangeConfig": {
        "startDateTimeKey": "createdSince",
        "endDateTimeKey": "createdBefore",
        "dateTimeFormat": "yyyy-MM-dd'T'HH:mm:ss"
      }
    },
    {
      "type": "WriteApiIntegration",
      "integrationId": "tetrapak-update-application-stage",
      "responseConfig": {
        "responseType": "SINGLE_ENTITY",
        "jsonataExpression": "$.data"
      },
      "dataModelRules": [
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "$exists(inputData.stageId) and inputData.stageId != null"
        },
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "$exists(inputData.status) and inputData.status != null"
        }
      ],
      "dataModelTarget": {
        "dataModelJsonataExpression": "{ \"JOVEO_APPLICATION_STAGE_ID\": $uuid(), \"JOVEO_APPLICATION_STAGE_APPLICATION_ID\": $.application_id, \"JOVEO_APPLICATION_STAGE_CUSTOMER_ID\": \"{{customer_id}}\", \"ATS_APPLICATION_STAGE_JOB_ID\": $.job_id, \"ATS_APPLICATION_STAGE_CANDIDATE_ID\": $.candidate_id, \"ATS_APPLICATION_STAGE_APPLICATION_ID\": $.application_id, \"ATS_APPLICATION_STAGE_ID\": $.id, \"ATS_APPLICATION_STAGE_NAME\": $.name, \"ATS_APPLICATION_STAGE_CREATED_DATE\": $fromMillis($toMillis($replace($.created_at, /\\+\\d{2}:\\d{2}$/, \"\") & \"Z\")), \"ATS_APPLICATION_STAGE_LAST_UPDATED_DATE\": $fromMillis($toMillis($replace($.updated_at, /\\+\\d{2}:\\d{2}$/, \"\") & \"Z\")), \"ATS_APPLICATION_STAGE_INSERTED_AT\": $now(), \"ATS_APPLICATION_STAGE_UPDATED_AT\": $now(), \"ATS_APPLICATION_STAGE_CUSTOM_FIELDS\": { \"status\": $.status, \"notes\": $.notes, \"assigned_to\": $.assigned_to, \"due_date\": $.due_date }, \"ATS_APPLICATION_STAGE_AUDIT\": { \"created_by\": $.created_by, \"updated_by\": $.updated_by } }",
        "targetFields": [
          "JOVEO_APPLICATION_STAGE_ID", "JOVEO_APPLICATION_STAGE_APPLICATION_ID", "JOVEO_APPLICATION_STAGE_CUSTOMER_ID", "ATS_APPLICATION_STAGE_JOB_ID", "ATS_APPLICATION_STAGE_CANDIDATE_ID", "ATS_APPLICATION_STAGE_APPLICATION_ID", "ATS_APPLICATION_STAGE_ID", "ATS_APPLICATION_STAGE_NAME", "ATS_APPLICATION_STAGE_CREATED_DATE", "ATS_APPLICATION_STAGE_LAST_UPDATED_DATE", "ATS_APPLICATION_STAGE_INSERTED_AT", "ATS_APPLICATION_STAGE_UPDATED_AT", "ATS_APPLICATION_STAGE_CUSTOM_FIELDS", "ATS_APPLICATION_STAGE_AUDIT"
        ],
        "targetOperation": "UPSERT"
      },
      "method": "PUT",
      "authTypes": ["API_KEY"],
      "apiPath": "/api/v1/applications/{applicationId}/stages/{stageId}",
      "headers": {
        "X-API-KEY": "{{api_key}}",
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      "requestPayload": {
        "requestBody": "{\"status\": \"${inputData.status}\", \"notes\": \"${inputData.notes}\", \"assigned_to\": \"${inputData.assignedTo}\", \"due_date\": \"${inputData.dueDate}\"}",
        "requestBodyConverter": []
      },
      "responseHandlers": [
        {
          "statusCode": 200,
          "bodyRules": [
            {
              "type": "BooleanExpressionRule",
              "jsonataExpression": "$exists($.id)"
            }
          ],
          "jsonataConvertorExpression": "{ \"stageId\": $.id, \"status\": $.status, \"updatedAt\": $.updated_at }"
        },
        {
          "statusCode": 404,
          "bodyRules": [
            {
              "type": "BooleanExpressionRule",
              "jsonataExpression": "true"
            }
          ],
          "jsonataConvertorExpression": "{ \"errorMessage\": \"Application stage not found\", \"details\": $.message }"
        },
        {
          "statusCode": 0,
          "bodyRules": [
            {
              "type": "BooleanExpressionRule",
              "jsonataExpression": "true"
            }
          ],
          "jsonataConvertorExpression": "{ \"errorMessage\": \"Integration not executed\" }"
        }
      ]
    },
    {
      "type": "ReadApiIntegration",
      "integrationId": "tetrapak-get-application-stages-demo",
      "responseConfig": {
        "responseType": "SINGLE_ENTITY",
        "jsonataExpression": "$"
      },
      "dataModelRules": [
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "true"
        }
      ],
      "dataModelTarget": null,
      "integrationDependency": {
        "dependentIntegrationId": "tetrapak-get-applications-demo",
        "dependencyFields": [
          {
            "type": "RestApiIntegrationField",
            "targetField": "CurrentStatus",
            "jsonataExpression": ["applied", "under_review", "shortlisted", "interviewed", "rejected", "hired"],
            "restApiIntegrationContext": "API_PATH"
          }
        ],
        "jsonDataType": "ARRAY_OF_PRIMITIVES",
        "queryType": "SINGLE_ENTITY"
      },
      "failSilently": true,
      "method": "GET",
      "authTypes": ["API_KEY"],
      "apiPath": "/api/v1/applications/{applicationId}/stages",
      "headers": {
        "X-API-KEY": "{{api_key}}",
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      "queryParams": {
        "PageSize": 1
      },
      "executionEligibilityRules": [
        {
          "type": "BooleanExpressionRule",
          "jsonataExpression": "true"
        }
      ]
    }
  ]
}
